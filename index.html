<!DOCTYPE html>
<html>
<head>
    <title>3D Heart - Debug Mode</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; color: white; }
        /* Small preview to see if camera is working */
        #video { width: 160px; height: 120px; border: 2px solid #555; position: fixed; bottom: 10px; right: 10px; display: block; }
        #status { padding: 5px 10px; background: red; border-radius: 5px; }
        button { padding: 12px 24px; cursor: pointer; background: #ff0044; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="ui">
        <button id="startBtn">START SYSTEM</button>
        <span id="status">HAND NOT DETECTED</span>
    </div>
    <video id="video" autoplay playsinline muted></video>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const videoElement = document.getElementById('video');

        startBtn.onclick = () => {
            startBtn.style.display = 'none';
            init();
        };

        function init() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const particleCount = 2500;
            const geometry = new THREE.BufferGeometry();
            const posArray = new Float32Array(particleCount * 3);
            const targetArray = new Float32Array(particleCount * 3);
            const initialArray = new Float32Array(particleCount * 3);

            for (let i = 0; i < particleCount; i++) {
                initialArray[i*3] = (Math.random()-0.5)*15;
                initialArray[i*3+1] = (Math.random()-0.5)*15;
                initialArray[i*3+2] = (Math.random()-0.5)*15;
                
                const t = Math.random() * Math.PI * 2;
                targetArray[i*3] = 0.15 * (16 * Math.pow(Math.sin(t), 3));
                targetArray[i*3+1] = 0.15 * (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                targetArray[i*3+2] = (Math.random()-0.5)*1.5;

                posArray[i*3] = initialArray[i*3];
                posArray[i*3+1] = initialArray[i*3+1];
                posArray[i*3+2] = initialArray[i*3+2];
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const material = new THREE.PointsMaterial({ size: 0.08, color: 0xff3366 });
            const points = new THREE.Points(geometry, material);
            scene.add(points);
            camera.position.z = 7;

            let handFound = false;
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.5 });
            
            hands.onResults((res) => {
                if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    handFound = true;
                    status.innerText = "HAND DETECTED!";
                    status.style.background = "green";
                } else {
                    handFound = false;
                    status.innerText = "SEARCHING...";
                    status.style.background = "orange";
                }
            });

            const cam = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            cam.start();

            function animate() {
                requestAnimationFrame(animate);
                const positions = geometry.attributes.position.array;
                for (let i = 0; i < particleCount * 3; i++) {
                    const target = handFound ? targetArray[i] : initialArray[i];
                    positions[i] += (target - positions[i]) * 0.06;
                }
                geometry.attributes.position.needsUpdate = true;
                points.rotation.y += 0.005;
                renderer.render(scene, camera);
            }
            animate();
        }
    </script>
</body>
</html>
